WITH distinct_market_groups AS (
  SELECT 
    fe.systemid,
    fe.next_negotiation_date,
    jsonb_array_elements(fe.tf_market_groups) AS market_group
  FROM facilities_entities fe
  LEFT JOIN amp_renewal_facilities arf
    ON fe.facility_entity_id = arf.facility_entity_id
  WHERE arf.renewal_id IS NULL
    AND fe.systemid != '1'
    AND fe.next_negotiation_date >= CURRENT_DATE
)
SELECT 
  systemid,
  MIN(next_negotiation_date) AS next_negotiation_date,
  jsonb_agg(DISTINCT market_group) AS tf_market_groups
FROM distinct_market_groups
GROUP BY systemid
ORDER BY next_negotiation_date ASC;
