Sub CreatePivotTable()

    Dim wsData As Worksheet
    Dim wsPivot As Worksheet
    Dim ptCache As pivotCache
    Dim pt As pivotTable
    Dim pivotRange As Range
    Dim pivotSheetName As String
    Dim lastRow As Long
    Dim firstValueRow As Long
    Dim lastCol As Long
    Dim BLUE_COLOR As Long
    Dim ORANGE_ACCENT_COLOR As Long
    Dim loadDateCol As Range, timeframeCol As Range
    Dim loadDate As String, timeframe As String

    ' Define colors
    BLUE_COLOR = RGB(17, 0, 129) ' #110081
    ORANGE_ACCENT_COLOR = RGB(255, 229, 204) ' Orange, Accent 2, Lighter 60%

    pivotSheetName = "Pivot Summary"

    ' Set the data worksheet
    Set wsData = ThisWorkbook.Sheets("DataSheet")

    ' Determine the data range dynamically
    lastRow = wsData.Cells(wsData.Rows.Count, 1).End(xlUp).Row
    lastCol = wsData.Cells(1, wsData.Columns.Count).End(xlToLeft).Column
    Set pivotRange = wsData.Cells(1, 1).Resize(lastRow, lastCol)

    ' Check if Pivot Summary exists, if not, create it
    On Error Resume Next
    Set wsPivot = ThisWorkbook.Sheets(pivotSheetName)
    On Error GoTo 0
    If wsPivot Is Nothing Then
        Set wsPivot = ThisWorkbook.Sheets.Add
        wsPivot.Name = pivotSheetName
    End If

    ' Delete existing pivot table if it exists
    On Error Resume Next
    For Each pt In wsPivot.PivotTables
        pt.TableRange2.Clear
    Next pt
    On Error GoTo 0

    ' Create PivotCache from the data
    Set ptCache = ThisWorkbook.PivotCaches.Create( _
        SourceType:=xlDatabase, _
        SourceData:=pivotRange)

    ' Create the PivotTable starting at row 15
    Set pt = wsPivot.PivotTables.Add( _
        pivotCache:=ptCache, _
        TableDestination:=wsPivot.Cells(15, 1), _
        TableName:="PivotTable1")

    ' Add Filters
    With pt
        .PivotFields("system_id").Orientation = xlPageField
        .PivotFields("facility_entity_id").Orientation = xlPageField
        .PivotFields("provider_name").Orientation = xlPageField
        .PivotFields("contract_office").Orientation = xlPageField
        .PivotFields("line_of_business").Orientation = xlPageField
        .PivotFields("msc_cd").Orientation = xlPageField
        .PivotFields("service_major").Orientation = xlPageField

        ' Add Rows
        .PivotFields("systemname").Orientation = xlRowField

        ' Add Values (Sum of each field)
        .AddDataField .PivotFields("repriced_claim_count"), "Sum of Repriced Claim Count", xlSum
        .AddDataField .PivotFields("repriced_allowed_"), "Sum of Repriced Allowed", xlSum
        .AddDataField .PivotFields("repriced_medicare_allowed"), "Sum of Repriced Medicare Allowed", xlSum
        .AddDataField .PivotFields("total_allowed"), "Sum of Total Allowed", xlSum
        .AddDataField .PivotFields("con_office_repr_allowed"), "Sum of Con Office Repr Allowed", xlSum
        .AddDataField .PivotFields("con_offirce_medicare_allowed"), "Sum of Con Office Medicare Allowed", xlSum
    End With

    ' Format "Sum of Repriced Claim Count" with commas
    pt.DataBodyRange.NumberFormat = "#,##0"

    ' Refresh the PivotTable to ensure all data is up to date
    pt.RefreshTable

    ' Add merged and styled text in Row 1 spanning columns A to C
    With wsPivot.Range("A1:C1")
        .Merge
        .Value = "***Repriced Percentages are calculated fields, based on hidden columns D-G. " & _
                 "Adding extra rows works, as long as you manually drag down columns H/I/J, to see the calculations***"
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter
        .WrapText = True
        .Interior.Color = ORANGE_ACCENT_COLOR
        .Font.Bold = True
        .Font.Size = 11
        .RowHeight = 70 ' Set row height to 70
    End With

    ' Ensure column A width is at least 60
    If wsPivot.Columns("A").ColumnWidth < 60 Then
        wsPivot.Columns("A").ColumnWidth = 60
    End If

    ' Determine the first and last rows of the Pivot Table values
    firstValueRow = pt.DataBodyRange.Cells(1, 1).Row
    lastRow = pt.DataBodyRange.Cells(pt.DataBodyRange.Rows.Count, 1).Row
    lastCol = pt.TableRange2.Columns.Count

    ' Retrieve load date from DataSheet
    On Error Resume Next
    Set loadDateCol = wsData.Rows(1).Find(What:="load_date", LookIn:=xlValues, LookAt:=xlWhole)
    If Not loadDateCol Is Nothing Then
        loadDate = wsData.Cells(2, loadDateCol.Column).Value
    Else
        loadDate = "Load Date"
    End If
    On Error GoTo 0

    ' Add Load Date text after everything else is set
    If loadDate = "" Then loadDate = "Load Date"
    wsPivot.Cells(3, 1).Value = "Load Date: " & loadDate

    ' Retrieve timeframe from DataSheet
    On Error Resume Next
    Set timeframeCol = wsData.Rows(1).Find(What:="timeframe", LookIn:=xlValues, LookAt:=xlWhole)
    If Not timeframeCol Is Nothing Then
        timeframe = wsData.Cells(2, timeframeCol.Column).Value
    Else
        timeframe = "Timeframe"
    End If
    On Error GoTo 0

    ' Add Timeframe text in A4
    If timeframe = "" Then timeframe = "Timeframe"
    wsPivot.Cells(4, 1).Value = "Timeframe: " & timeframe

    ' Add helper text reflecting divided column names with asterisks
    With wsPivot.Cells(14, 8)
        .Value = "**repriced_allowed divided by total_allowed**"
        .Font.Size = 9
        .WrapText = True
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter
        .MergeCells = True
    End With

    With wsPivot.Cells(14, 9)
        .Value = "**repriced_allowed divided by repriced_medicare_allowed**"
        .Font.Size = 9
        .WrapText = True
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter
        .MergeCells = True
    End With

    With wsPivot.Cells(14, 10)
        .Value = "**con_office_repr_allowed divided by con_office_medicare_allowed**"
        .Font.Size = 9
        .WrapText = True
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter
        .MergeCells = True
    End With

    ' Hide columns D to G
    With wsPivot
        .Columns("D:G").ColumnWidth = 0
        .Columns(lastCol + 1).ColumnWidth = 30
    End With

End Sub


