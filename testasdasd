WITH facility_data AS (
  SELECT
    fe.system_id,
    fe.facility_entity_id,
    fe.name,
    fe.system,
    fe.next_negotiation_date::DATE AS next_negotiation_date,
    fe.tf_market_groups
  FROM facility_entity fe
  LEFT JOIN amp_renewal_facilities arf ON fe.facility_entity_id = arf.facility_entity_id
  WHERE arf.renewal_id IS NULL
    AND fe.next_negotiation_date >= CURRENT_DATE
),
individual_facilities AS (
  SELECT
    facility_entity_id::text AS id,
    system_id,
    name,
    system,
    next_negotiation_date,
    tf_market_groups
  FROM facility_data
  WHERE system_id = '1'
),
grouped_facilities AS (
  SELECT
    system_id AS id,
    system_id,
    (system->>'systemname') AS name,
    system,
    MIN(next_negotiation_date) AS next_negotiation_date,
    (
      SELECT jsonb_agg(DISTINCT grp)
      FROM facility_data fd2, jsonb_array_elements(fd2.tf_market_groups) AS grp
      WHERE fd2.system_id = fd.system_id
    ) AS tf_market_groups
  FROM facility_data fd
  WHERE system_id != '1'
  GROUP BY system_id, system
),
combined AS (
  SELECT * FROM individual_facilities
  UNION ALL
  SELECT * FROM grouped_facilities
)
SELECT
  id,
  system_id,
  name,
  system,
  next_negotiation_date,
  tf_market_groups,
  COUNT(*) OVER() AS total_count
FROM combined
ORDER BY next_negotiation_date ASC
LIMIT $1 OFFSET $2;
